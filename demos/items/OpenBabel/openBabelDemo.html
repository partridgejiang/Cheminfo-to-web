<!doctype html>
<html><!-- InstanceBegin template="/Templates/DemoTemplate.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
	<meta charset="utf-8">
	<!-- InstanceBeginEditable name="doctitle" -->
	<title>OpenBabel Demo - Cheminf-to-web Project</title>
	<!-- InstanceEndEditable -->
	<link href="../../../styles/base.css" rel="stylesheet" type="text/css">	
	
	<link href="../../../styles/default.css" rel="stylesheet" type="text/css">
	
	<link href="../../../styles/demos.css" rel="stylesheet" type="text/css">
	<script src="../../scripts/demoUtils.js"></script>	
	<!-- InstanceBeginEditable name="demoHead" -->
	<link href="../../../libs/kekule/themes/default/kekule.css" rel="stylesheet" type="text/css">
	
	<script id="scriptOb" src="../../../libs/compiled/openbabel.js"></script>
	<script src="../../../libs/raphael-min.2.0.1.js"></script>	
	<script src="../../../libs/Three.js"></script>	
	<!--
	<script src="../../../libs/kekule/kekule.js?modules=io,chemWidget,openbabel"></script>			
	-->
	<script src="http://127.0.0.1:8080/src/kekule.js?min=false&modules=io,chemWidget,openbabel"></script>			
	<script>
		var OpenBabel;		
		function reactOpenBabelReady(e)
		{		
			//var OpenBabel = OpenBabelModule();
			OpenBabel = e.detail.module;
						
			var fillFormatSelector = function(selElem, formatStrs)
			{
				selElem.innerHTML = '';
				for (var i = 0, l = formatStrs.length; i < l; ++i)
				{
					var sFmt = formatStrs[i];
					var detail = sFmt.split(' -- ');
					var id = detail[1]? detail[0]: '[none]';						
					var item = document.createElement('option');
					item.setAttribute('value', id);		
					item.innerHTML = sFmt;        
					selElem.appendChild(item);
				}
			}
			
			// Format enumeration
			var fillObFormatEnumSelector = function()
			{
				var conv = new OpenBabel.ObConversionWrapper();
				try
				{
					// list all supported input/output formats, use '\n' to separate between each format string
					var sInputFormats = conv.getSupportedInputFormatsStr('\n');
					var sOutputFormats = conv.getSupportedOutputFormatsStr('\n');
					var inFormats = sInputFormats.split('\n');
					var outFormats = sOutputFormats.split('\n');
					for (var i = 0, l = outFormats.length; i < l; ++i)
					{
						var sFmt = outFormats[i];
						if (inFormats.indexOf(sFmt) < 0)
							inFormats.push(sFmt);
					}
					inFormats.sort(function(a, b){
						var sa = a.toLowerCase();
						var sb = b.toLowerCase();
						return (sa < sb)? -1:
							(sa > sb)? 1: 0;
					});
					inFormats.unshift('(Select a format)');
					
					var selector = $('selObFormats');
					fillFormatSelector(selector, inFormats);
					selector.onchange = function()
					{
						var conv = new OpenBabel.ObConversionWrapper();
						try
						{
							var sOutput = '';
							var id = selector.value;
							if (id !== '[none]')  // not empty item
							{
								var fmtInfo = conv.getFormatInfoById(id);
								sOutput = [
									'ID: ' + fmtInfo.id,
									'MIME type: ' + fmtInfo.mimeType,
									'Specification URL: ' + fmtInfo.specificationURL,
									'Description: ' + fmtInfo.description
								].join('\n');
							}
							$('textAreaFormatDetail').value = sOutput;
						}
						finally
						{
							conv.delete(); 
						}
					}
				}
				finally
				{
					conv.delete();  // free ObConversionWrapper instance
				}
			};
			fillObFormatEnumSelector();
			
			
			$('btnListFormats').onclick = function()
			{
				var conv = new OpenBabel.ObConversionWrapper();  // create ObConversionWrapper instance
				try
				{
					// list all supported input/output formats, use '\n' to separate between each format string
					var sInputFormats = conv.getSupportedInputFormatsStr('\n');
					var sOutputFormats = conv.getSupportedInputFormatsStr('\n');
					$('textAreaFormats').value = '[In formats]\n' + sInputFormats + '\n\n' + '[Out formats]\n' + sOutputFormats;
				}
				finally
				{
					conv.delete();  // free ObConversionWrapper instance
				}
			}
			
			// Data conversion
			var fillConvInOutFormatSelector = function()
			{
				var conv = new OpenBabel.ObConversionWrapper();
				try
				{
					// list all supported input/output formats, use '\n' to separate between each format string
					var sInputFormats = conv.getSupportedInputFormatsStr('\n');
					var sOutputFormats = conv.getSupportedOutputFormatsStr('\n');
					var inFormats = sInputFormats.split('\n');
					var outFormats = sOutputFormats.split('\n');
					
					fillFormatSelector($('selInFormats'), inFormats);
					fillFormatSelector($('selOutFormats'), outFormats);
				}
				finally
				{
					conv.delete();  // free ObConversionWrapper instance
				}
			}
			fillConvInOutFormatSelector();
			
			var inputMolListElem = $('listInputMol');
			DemoUtils.initMolList(inputMolListElem, {'textArea': $('textAreaInData'), 'viewer': $('chemViewerInput')});
			var oldInputMolListOnChange = inputMolListElem.onchange;
			inputMolListElem.onchange = function(){
				if (oldInputMolListOnChange)
					oldInputMolListOnChange(inputMolListElem);
				// set value of input format
				$('selInFormats').value = 'mdl';
			}
			
			var filePickerInputElem = $('filePickerInput');
			DemoUtils.assocFilePickerRelatedElems(filePickerInputElem, {'contentDisplayer': $('textAreaInData'), 'molViewer': null});
			var oldInputFilePickerOnChange = filePickerInputElem.onchange;
			filePickerInputElem.onchange = function()
			{
				if (oldInputFilePickerOnChange)
					oldInputFilePickerOnChange(filePickerInputElem);
				var fileName = filePickerInputElem.files[0].name || '';	
				// load in molecule viewer
				Kekule.IO.loadFileData(filePickerInputElem.files[0], function(kObj, success){
					if (success)
						Kekule.Widget.getWidgetById('chemViewerInput').setChemObj(kObj);
				});				
				// set value of input format
				var conv = new OpenBabel.ObConversionWrapper();
				try
				{					
					var pos = fileName.lastIndexOf('.');	
					if (pos >= 0)
					{				
						var fileExt = fileName.substr(pos + 1);
						var fmt = conv.setInFormat('', fileExt);
						if (fmt)
							$('selInFormats').value = fmt.getId();
					}
				}
				finally
				{
					conv.delete();  // free ObConversionWrapper instance
				}
			}
			
			var modifyMol = function(mol)
			{
				var atomCount = mol.NumAtoms();  // get atom number of molecule
				for (var i = 0; i < atomCount; ++i)
				{
					var atom = mol.GetAtom(i + 1);  // note: OpenBabel atom starts with index 1, not 0
					var atomicNum = atom.GetAtomicNum();
					if (atomicNum === 6)  // is C atom
					{
						atom.SetIsotope(13)  // change mass number to 13
					}
				}
			}
			var doConversion = function(molModifier)
			{
				var conv = new OpenBabel.ObConversionWrapper();  // create ObConversionWrapper instance
				try
				{
					var inData = $('textAreaInData').value;   // set input data
					var inFormatId = $('selInFormats').value;
					var outFormatId = $('selOutFormats').value;
					if (inData && inFormatId && outFormatId)
					{
						conv.setInFormat('', inFormatId);
						var mol = new OpenBabel.OBMol();
						conv.readString(mol, inData);  // read input data, returns a molecule object						
						if (molModifier)
							molModifier(mol);
						conv.setOutFormat('', outFormatId);  // set out format by file extension
						var outData = conv.writeString(mol, false);  // get output data, do not trim white spaces						
						$('textAreaOutData').value = outData;
						// show converted molecule in viewer
						var kObj = Kekule.OpenBabel.AdaptUtils.obObjToKekule(mol);
						Kekule.Widget.getWidgetById('chemViewerOutput').setChemObj(kObj);
					}
				}
				finally
				{
					conv.delete();  // free ObConversionWrapper instance
				}
			}
			
			$('btnConv').onclick = function()
			{
				doConversion();
			}
			$('btnConvWithModification').onclick = function()
			{
				doConversion(modifyMol);
			}
			
			var inputFFMolListElem = $('listInputMolFF');
			DemoUtils.initMolList(inputFFMolListElem, {'textArea': $('textAreaInDataFF'), 'viewer': $('chemViewerInputFF')}, demoMol3DData);
			
			var filePickerInputFFElem = $('filePickerInputFF');
			DemoUtils.assocFilePickerRelatedElems(filePickerInputFFElem, {'contentDisplayer': $('textAreaInDataFF'), 'molViewer': $('chemViewerInputFF')});
			
			btnRunFF.onclick = function()
			{
				var kMol = Kekule.Widget.getWidgetById('chemViewerInputFF').getChemObj();
				if (kMol)
				{
					var mol = Kekule.OpenBabel.AdaptUtils.kObjToOB(kMol);
					try
					{
						//mol.AddHydrogens(null);
						var FF = new OpenBabel.OBForceField.FindForceField("ghemical");
						try
						{
							FF.SetLogLevel(3); // OBFF_LOGLVL_HIGH
							if (!FF.Setup(mol))
								console.log('Error set force field');
							var sUnit = FF.GetUnit();
							$('textAreaOutDataFF').value = 'Molecule total energy: ' + FF.Energy(true) + sUnit + '\n'
								+ '  Bond stretching energy: ' + FF.E_Bond(true) + sUnit + '\n'
								+ '  Angle bending energy: ' + FF.E_Angle(true) + sUnit + '\n'
								+ '  Stretch bending energy: ' + FF.E_StrBnd(true) + sUnit + '\n'
								+ '  Torsional energy: ' + FF.E_Torsion(true) + sUnit + '\n'
								+ '  Out-Of-Plane bending energy: ' + FF.E_OOP(true) + sUnit + '\n'
								+ '  Van der Waals energy: ' + FF.E_VDW(true) + sUnit + '\n'
								+ '  Electrostatic energy: ' + FF.E_Electrostatic(true) + sUnit + '\n';
						}
						finally
						{
						}
					}
					finally
					{
						mol.delete();
					}
				}
			}

			var inputOpMolListElem = $('listInputMolOp');
			DemoUtils.initMolList(inputOpMolListElem, {'textArea': $('textAreaInDataOp'), 'viewer': $('chemViewerInputOp')}, demoMolData);

			var filePickerInputOpElem = $('filePickerInputOp');
			DemoUtils.assocFilePickerRelatedElems(filePickerInputOpElem, {'contentDisplayer': $('textAreaInDataOp'), 'molViewer': $('chemViewerInputOp')});

			$('btnRunOp').onclick = function()
			{
				var kMol = Kekule.Widget.getWidgetById('chemViewerInputOp').getChemObj();
				if (kMol)
				{
					var mol = Kekule.OpenBabel.AdaptUtils.kObjToOB(kMol);					
					try
					{						
						var gen3d = OpenBabel.OBOp.FindType('Gen3D');						
						try
						{							
							gen3d.Do(mol, '');
							var kMolOut = Kekule.OpenBabel.AdaptUtils.obObjToKekule(mol);
							Kekule.Widget.getWidgetById('chemViewerOutputOp').setChemObj(kMolOut);
							var sOutput = Kekule.IO.saveFormatData(kMolOut, 'mol');
							$('textAreaOutDataOp').value = sOutput;
						}
						finally
						{
							//gen3d.delete();
						}
					}
					finally
					{
						mol.delete();
					}
				}
			}
		}
		
		document.addEventListener('OpenBabel.Initialized', reactOpenBabelReady);
	</script>
	<!-- InstanceEndEditable -->
	
	
</head>

<body>
	<header class="MainHeader" id="mainHeader">
		<h1 class="HeadTitle">Cheminfo-to-web Project</h1>
		<nav class="MainNav" id="mainNav">			
			
			<a id="logo"  href="../../../index.html" title="Project Home"><span>Cheminf-to-web</span></a>
			<a href="../../../index.html">Overview</a>
			<a href="../../index.html" target="_blank">Demos</a>
			<!--
			<a href="../documents/tutorial/index.html" target="_blank">Tutorial</a>
			<a href="../documents/index.html">Documents</a>
			-->
			<a href="../../../download/index.html">Download</a>
			<!-- InstanceBeginEditable name="AdditionalMainNavItems" -->
			<!-- InstanceEndEditable -->			
						
		</nav>
	</header>	
	<section class="MainContent" id="mainContent">    			
		
			<nav class="SideNav">				
				<a href="../../../index.html">Overview</a>
				<a href="../../index.html">Demos</a>
				<!--
				<a href="../documents/tutorial/index.html" target="_blank">Tutorial</a>
				<a href="../documents/index.html">Documents</a>
				-->
				<a href="../../../downloads.html">Download</a>
				<!-- InstanceBeginEditable name="SideNavContent" -->
				<!-- InstanceEndEditable -->						
			</nav>
						
		<article id="mainArticle" class="MainArticle">			
			<header>
				<!-- InstanceBeginEditable name="PossibleGroupSection" -->
				<!-- InstanceEndEditable -->				
				<h1 class="MainTitle" id="mainTitle"><!-- InstanceBeginEditable name="ArticleHeadLine" -->Open Babel Demo<!-- InstanceEndEditable --></h1>
			</header>		
			<!-- InstanceBeginEditable name="MainContent" -->
			<h2>Overview</h2>
			<p>To use the OpenBabel JS compilation, the JavaScript file firstly be included in HTML file:</p>
			<pre class="CodeBlock">&lt;script src=&quot;openbabel.js&quot;&gt;&lt;/script&gt;<br></pre>
			<p>The openbabel.js will then load openbabel.wasm, the web assembly compiled from OpenBabel lib. This is a asynchronous process and a custom event <i>OpenBabel.Initialized</i> binding on HTML document will notify that the OpenBabel module is ready:</p>
			<pre class="CodeBlock">document.addEventListener('OpenBabel.Initialized', function(e){
	var OpenBabel = e.detail.module;
	// ...
})</pre>
			<p>Another approach to detect the ready of OpenBabel is to define a speciallized function before the openbabel.js script tag:</p>
			<pre class="CodeBlock">&lt;script&gt;
function __$openBabelInitialized$__(e)
{
  var OpenBabel = e.module;
  // ...
}
&lt;/script&gt;
&lt;script src=&quot;openbabel.js&quot;&gt;&lt;/script&gt;
			</pre>
			<p>After loading, all useful classes are can be accessed from that OpenBabel module. In native OpenBabel, the core class to do data format conversion is <span class="InlineCode">OBConversion</span>. For some reason, in JavaScript compiliation, a wrapper class <span class="InlineCode">ObConversionWrapper</span> is created to wrap functions of OBConversion. Most of I/O job can be done with this wrapper class.</p>
			<h2>Enumeration Supported Formats</h2>
			<p>OpenBabel supports a lot of different chemical formats (note that not all of them are ported to JavaScript currently).  To list all of them, the following JavaScript code can be used:</p>
			<pre class="CodeBlock">var conv = new OpenBabel.ObConversionWrapper();  // create ObConversionWrapper instance
try
{
	// list all supported input/output formats, use '\n' to separate between each format string
	var sInputFormats = conv.getSupportedInputFormatsStr('\n');
	var sOutputFormats = conv.getSupportedInputFormatsStr('\n');
	console.log(sInputFormats);
	console.log(sOutputFormats);
}
finally
{
	conv.delete();  // free ObConversionWrapper instance
}</pre>
			<p>Live demo:</p>
			<section class="DemoSection">
				<button id="btnListFormats" data-widget="Kekule.Widget.Button">List All I/O Formats</button><br />
				<textarea id="textAreaFormats" class="DemoBlockTextArea" style="width:90%;height:150px;"></textarea>
			</section>
			<p>&nbsp;</p>
			<p>It can be seen from the demo above that the each item of returned format string of <span class="InlineCode">getSupportedInputFormatsStr</span> / <span class="InlineCode">getSupportedOutputFormatsStr</span>  contains two parts: format id and format description with a delimiter of &quot;--&quot;. You can then extract the id and get more informations from it:</p>
			<pre class="CodeBlock">var conv = new OpenBabel.ObConversionWrapper();  // create ObConversionWrapper instance
try
{
	var formatId = &quot;mol&quot;;
	var formatInfo = conv.getFormatInfoById(formatId);  // returns detailed format info
	console.log(formatInfo.id, formatInfo.mimeType, formatInfo.specificationURL, formatInfo.description);
}
finally
{
	conv.delete();  // free ObConversionWrapper instance
}</pre>
			<p>Live demo:</p>
			<section class="DemoSection">
				<select id="selObFormats"></select><br />
				<textarea id="textAreaFormatDetail" class="DemoBlockTextArea" style="width:90%;height:150px;"></textarea>
			</section>
			<h2>Convert between Data Formats</h2>
			<p>The dominate use of class <span class="InlineCode">ObConversionWrapper</span> is to do conversion between different data formats:</p>
			<pre class="CodeBlock">
var conv = new OpenBabel.ObConversionWrapper();  // create ObConversionWrapper instance
try
{
	var inData = '...';   // set input data
	conv.setInFormat('', 'mol');  // set input format by file extension
		// the input format can also be set by MIME type:
		// conv.setInFormat('chemical/x-mdl-molfile');
	var mol = new OpenBabel.OBMol();  // create a new molecule object...
	conv.readString(mol, inData);  // ... and load it with input data
	conv.setOutFormat('', 'pdb');  // set out format by file extension
	var outData = conv.writeString(mol, false);  // get output data, do not trim white spaces
	console.log(outData);
}
finally
{
	conv.delete();  // free ObConversionWrapper instance
}</pre>
			<p>It is noticeable that during the conversion, an OBMol object is created. This object holds the structure of a molecule, and you can even manipulate it with OpenBabel API before saving it. For example, the following code will change mass number of all C atoms in molecule to 13:</p>
			<pre class="CodeBlock">
// ...
var mol = new OpenBabel.OBMol();
conv.readString(mol, inData);
var atomCount = mol.NumAtoms();  // get atom number of molecule
for (var i = 0; i &lt; atomCount; ++i)
{
	var atom = mol.GetAtom(i + 1);  // note: OpenBabel atom starts with index 1, not 0
	var atomicNum = atom.GetAtomicNum();
	if (atomicNum === 6)  // is C atom
	{
		atom.SetIsotope(13)  // change mass number to 13
	}
}
// ...</pre>
			<p>Live demo:</p>
			<section class="DemoSection">
				<p>
					<label for="listInputMol">Select source molecule data: </label><select id="listInputMol"></select><br />
					<label for="filePickerInput">Or load source data from file: </label><input type="file" id="filePickerInput" />
				</p>
				<label for="selInFormats">Input data format: </label><select id="selInFormats"></select><br />
				<textarea id="textAreaInData" class="DemoTextArea" style="width:60%;height:150px;"></textarea>
				<div id="chemViewerInput" class="MolViewer" style="width:30%;height:150px;" data-widget="Kekule.ChemWidget.Viewer2D" data-predefined-setting="basic"></div>
				<br />
				<label for="selOutFormats">Output data format: </label><select id="selOutFormats"></select>
				<button id="btnConv" data-widget="Kekule.Widget.Button">Convert</button><button id="btnConvWithModification" data-widget="Kekule.Widget.Button">Convert to 13C</button>
				<br />
				<textarea id="textAreaOutData" class="DemoTextArea" style="width:60%;height:150px;"></textarea>
				<div id="chemViewerOutput" class="MolViewer" style="width:30%;height:150px;" data-widget="Kekule.ChemWidget.Viewer2D" data-predefined-setting="basic"></div>
			</section>
			<h2>Force Field Calculation</h2>
			<p>Aside from molecule I/O, Open Babel supports molecular modeling to some degree. The core class <span class="InlineCode">OBForceField</span> is also exported in current JavaScript compilation. It can be called in a similar way to native C++ code. For example, the following codes calculate the energy of a molecule (the JavaScript codes are actaully borrowed from C++ code from obenergy program of OpenBabel):</p>
			<pre class="CodeBlock">var FF = new OpenBabel.OBForceField.FindForceField("ghemical");
FF.SetLogLevel(3); // OBFF_LOGLVL_HIGH
if (!FF.Setup(mol))
	console.log('Error set force field');
var sUnit = FF.GetUnit();
var msg = 'Molecule total energy: ' + FF.Energy(true) + sUnit + '\n'
	+ '  Bond stretching energy: ' + FF.E_Bond(true) + sUnit + '\n'
	+ '  Angle bending energy: ' + FF.E_Angle(true) + sUnit + '\n'
	+ '  Stretch bending energy: ' + FF.E_StrBnd(true) + sUnit + '\n'
	+ '  Torsional energy: ' + FF.E_Torsion(true) + sUnit + '\n'
	+ '  Out-Of-Plane bending energy: ' + FF.E_OOP(true) + sUnit + '\n'
	+ '  Van der Waals energy: ' + FF.E_VDW(true) + sUnit + '\n'
	+ '  Electrostatic energy: ' + FF.E_Electrostatic(true) + sUnit + '\n';
console.log(msg);
			</pre>
			<p>Live demo:</p>
			<section class="DemoSection">
				<p>
					<label for="listInputMolFF">Select source molecule data: </label><select id="listInputMolFF"></select><br />
					<label for="filePickerInputFF">Or load source data from file: </label><input type="file" id="filePickerInputFF" />
				</p>
				<textarea id="textAreaInDataFF" class="DemoTextArea" style="width:60%;height:150px;"></textarea>
				<div id="chemViewerInputFF" class="MolViewer" style="width:30%;height:150px;" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="basic"></div>
				<br />
				<button id="btnRunFF" data-widget="Kekule.Widget.Button">Calculate Energy</button>
				<br />
				<textarea id="textAreaOutDataFF" class="DemoTextArea" style="height:150px;"></textarea>
			</section>
			<h2>OpenBabel Operation</h2>
			<p>The OpenBabel library provides a series of instances of <span class="InlineCode">OBOp</span> to perform some useful operations on molecule (e.g., 2D diagram and 3D structure generation). In the JavaScript code, you can call those operations similarly to the C++ code. For example, the following codes can be used to generate 3D coordinates of atoms from a 2D molecule structure:</p>
			<pre class="CodeBlock">var molData = '....';  // MOL format molecule data
var conv = new OpenBabel.ObConversionWrapper();
conv.setInFormat('', 'mol');
var mol = new OpenBabel.OBMol();
conv.readString(mol, molData);
var gen3d = OpenBabel.OBOp.FindType("Gen3D");
if (!gen3d.Do(mol, ''))
  console.error('Generate 3D failed');
else
{
  conv.setOutFormat('', 'mol');
  var outputData = conv.writeString(mol, false);
  console.log(outputData);
}
conv.delete();
			</pre>
			<p>Live demo:</p>
			<section class="DemoSection">
				<p>
					<label for="listInputMolOp">Select source molecule data: </label><select id="listInputMolOp"></select><br />
					<label for="filePickerInputOp">Or load source data from file: </label><input type="file" id="filePickerInputOp" />
				</p>
				<textarea id="textAreaInDataOp" class="DemoTextArea" style="width:60%;height:150px;"></textarea>
				<div id="chemViewerInputOp" class="MolViewer" style="width:30%;height:150px;" data-widget="Kekule.ChemWidget.Viewer2D" data-predefined-setting="basic"></div>
				<br />
				<button id="btnRunOp" data-widget="Kekule.Widget.Button">Generate 3D</button>
				<br />
				<textarea id="textAreaOutDataOp" class="DemoTextArea" style="width:60%;height:150px;"></textarea>
				<div id="chemViewerOutputOp" class="MolViewer" style="width:30%;height:150px;" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="basic"></div>
			</section>
			<!-- InstanceEndEditable -->
		</article>
	</section>
	<footer class="MainFooter" id="mainFooter">
		<span>Copyright 2017 Kekule.js Lab</span>
	</footer>
</body>
<!-- InstanceEnd --></html>
